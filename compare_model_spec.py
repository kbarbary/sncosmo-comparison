#!/usr/bin/env python

import numpy as np
import sncosmo
import matplotlib.pyplot as plt

# read in spectrum from snfit, created with phase=0
wave, flux1 = np.loadtxt("src/snfit-2.4.2/src/testspec.dat", unpack=True)

z = 0.05

# adjust flux by a^2 for some reason. Why? What is the definition of
# "rest frame flux" in snfit?
flux1 *= 1. / (1. + z)**2

# evalute sncosmo model with same spec
model = sncosmo.Model('salt2', effects=[sncosmo.CCM89Dust()],
                      effect_names=['mw'], effect_frames=['obs'])
model.set(z=z)
flux2 = model.flux(0., wave)


#plt.plot(wave, flux1)
#plt.plot(wave, flux2)
#plt.show()

#plt.clf()
#plt.plot(wave, flux2/flux1)

# overplot grid
wgrid = model.source._wave * (1. + z)
#plt.plot(wgrid, np.ones_like(wgrid), ls='none', marker ='o')

#plt.show()


# compare covariance with parameters from fitting SDSS19230 with snfit:

# last evaluation
model.set(t0=54390.4478055,
          z=0.221,
          c=0.0774572207493,
          x0=5.54909505246e-05,
          x1=-1.69392055944,
          mwebv=0.0493)

# model covariance from salt2

gcov = """
 7.330114144e-06 1.518440648e-10 2.120843104e-10 2.243632586e-10 2.044266221e-10 8.224784911e-11 5.651721412e-11 2.714715353e-11 1.911928001e-11 1.478561758e-11 1.401421858e-11 1.276311422e-11 1.188595609e-11 1.062405818e-11 1.033562406e-11
 1.518440648e-10 8.879247039e-08 1.974546477e-08 2.088865891e-08 1.903251899e-08 7.657435879e-09 5.261863353e-09 2.527453176e-09 1.780042424e-09 1.376569962e-09 1.304751204e-09 1.188270937e-09 1.106605797e-09 9.891206292e-10 9.622668481e-10
 2.120843104e-10 1.974546477e-08 8.118133605e-08 2.917569959e-08 2.658318368e-08 1.069532754e-08 7.349372936e-09 3.530155521e-09 2.486228687e-09 1.922688855e-09 1.822377843e-09 1.659687012e-09 1.545623319e-09 1.381528918e-09 1.344021586e-09
 2.243632586e-10 2.088865891e-08 2.917569959e-08 9.34913321e-08 2.81222581e-08 1.131455002e-08 7.774876218e-09 3.73453932e-09 2.630172732e-09 2.034005892e-09 1.927887219e-09 1.755777151e-09 1.635109565e-09 1.461514665e-09 1.421835789e-09
 2.044266221e-10 1.903251899e-08 2.658318368e-08 2.81222581e-08 1.039774164e-07 1.030915336e-08 7.084010511e-09 3.40269286e-09 2.396458896e-09 1.85326669e-09 1.756577589e-09 1.599761005e-09 1.489815788e-09 1.331646313e-09 1.295493252e-09
 8.224784911e-11 7.657435879e-09 1.069532754e-08 1.131455002e-08 1.030915336e-08 1.053816796e-07 2.85014066e-09 1.36902017e-09 9.641776971e-10 7.456328221e-10 7.067314766e-10 6.436387806e-10 5.994040449e-10 5.357670342e-10 5.212214164e-10
 5.651721412e-11 5.261863353e-09 7.349372936e-09 7.774876218e-09 7.084010511e-09 2.85014066e-09 5.759544871e-08 9.407322736e-10 6.625417922e-10 5.123670748e-10 4.856357293e-10 4.422811195e-10 4.118848957e-10 3.68156256e-10 3.581611278e-10
 2.714715353e-11 2.527453176e-09 3.530155521e-09 3.73453932e-09 3.40269286e-09 1.36902017e-09 9.407322736e-10 5.762709334e-08 3.182415134e-10 2.461074535e-10 2.332674727e-10 2.124427688e-10 1.978424215e-10 1.768380583e-10 1.720370559e-10
 1.911928001e-11 1.780042424e-09 2.486228687e-09 2.630172732e-09 2.396458896e-09 9.641776971e-10 6.625417922e-10 3.182415134e-10 3.894180305e-08 1.733293072e-10 1.642863265e-10 1.496198406e-10 1.393370635e-10 1.245440465e-10 1.211627819e-10
 1.478561758e-11 1.376569962e-09 1.922688855e-09 2.034005892e-09 1.85326669e-09 7.456328221e-10 5.123670748e-10 2.461074535e-10 1.733293072e-10 6.788685517e-08 1.270484451e-10 1.157063312e-10 1.077542949e-10 9.631432999e-11 9.369947812e-11
 1.401421858e-11 1.304751204e-09 1.822377843e-09 1.927887219e-09 1.756577589e-09 7.067314766e-10 4.856357293e-10 2.332674727e-10 1.642863265e-10 1.270484451e-10 1.748910407e-07 1.09669671e-10 1.021325104e-10 9.128939425e-11 8.881096509e-11
 1.276311422e-11 1.188270937e-09 1.659687012e-09 1.755777151e-09 1.599761005e-09 6.436387806e-10 4.422811195e-10 2.124427688e-10 1.496198406e-10 1.157063312e-10 1.09669671e-10 3.212299467e-07 9.301473983e-11 8.31396313e-11 8.088246126e-11
 1.188595609e-11 1.106605797e-09 1.545623319e-09 1.635109565e-09 1.489815788e-09 5.994040449e-10 4.118848957e-10 1.978424215e-10 1.393370635e-10 1.077542949e-10 1.021325104e-10 9.301473983e-11 4.373284014e-07 7.742577482e-11 7.532373111e-11
 1.062405818e-11 9.891206292e-10 1.381528918e-09 1.461514665e-09 1.331646313e-09 5.357670342e-10 3.68156256e-10 1.768380583e-10 1.245440465e-10 9.631432999e-11 9.128939425e-11 8.31396313e-11 7.742577482e-11 5.814610946e-07 6.732682631e-11
 1.033562406e-11 9.622668481e-10 1.344021586e-09 1.421835789e-09 1.295493252e-09 5.212214164e-10 3.581611278e-10 1.720370559e-10 1.211627819e-10 9.369947812e-11 8.881096509e-11 8.088246126e-11 7.532373111e-11 6.732682631e-11 5.986208889e-08
"""

rcov = """
 1.607334919e-07 8.969114806e-11 1.305736366e-10 1.433570483e-10 1.484259483e-10 1.046903485e-10 8.881586833e-11 5.818582734e-11 4.403860391e-11 3.32764275e-11 3.070967718e-11 2.627847415e-11 1.939496342e-11 1.847476418e-11
 8.969114806e-11 8.630951983e-08 2.165231408e-09 2.377211752e-09 2.461266557e-09 1.736022956e-09 1.472785109e-09 9.648638434e-10 7.302681523e-10 5.518048501e-10 5.092418293e-10 4.35761606e-10 3.216161015e-10 3.063569392e-10
 1.305736366e-10 2.165231408e-09 6.612165215e-08 3.46077835e-09 3.58314652e-09 2.52732667e-09 2.144101305e-09 1.404662373e-09 1.063134662e-09 8.033252726e-10 7.413614275e-10 6.343878834e-10 4.682132503e-10 4.459987469e-10
 1.433570483e-10 2.377211752e-09 3.46077835e-09 8.807302929e-08 3.933943497e-09 2.774756841e-09 2.354012972e-09 1.542181537e-09 1.167217602e-09 8.819723711e-10 8.139421457e-10 6.964956847e-10 5.140522334e-10 4.896628872e-10
 1.484259483e-10 2.461266557e-09 3.58314652e-09 3.933943497e-09 7.605941509e-08 2.872868272e-09 2.437247501e-09 1.596710869e-09 1.208488746e-09 9.13157652e-10 8.427219751e-10 7.211227753e-10 5.322283848e-10 5.069766662e-10
 1.046903485e-10 1.736022956e-09 2.52732667e-09 2.774756841e-09 2.872868272e-09 9.044946539e-08 1.719081421e-09 1.126219635e-09 8.523921145e-10 6.440840963e-10 5.944031905e-10 5.086347468e-10 3.75400499e-10 3.575895215e-10
 8.881586833e-11 1.472785109e-09 2.144101305e-09 2.354012972e-09 2.437247501e-09 1.719081421e-09 7.140554821e-08 9.554479113e-10 7.231415973e-10 5.464198862e-10 5.042722302e-10 4.315090871e-10 3.18477508e-10 3.033672571e-10
 5.818582734e-11 9.648638434e-10 1.404662373e-09 1.542181537e-09 1.596710869e-09 1.126219635e-09 9.554479113e-10 8.078522566e-08 4.737508388e-10 3.57975368e-10 3.303632276e-10 2.826940018e-10 2.086437665e-10 1.98744607e-10
 4.403860391e-11 7.302681523e-10 1.063134662e-09 1.167217602e-09 1.208488746e-09 8.523921145e-10 7.231415973e-10 4.737508388e-10 5.965892201e-08 2.709377208e-10 2.500391588e-10 2.139601642e-10 1.57914403e-10 1.504221118e-10
 3.32764275e-11 5.518048501e-10 8.033252726e-10 8.819723711e-10 9.13157652e-10 6.440840963e-10 5.464198862e-10 3.57975368e-10 2.709377208e-10 7.769247409e-08 1.889344621e-10 1.616724705e-10 1.19323201e-10 1.136618797e-10
 3.070967718e-11 5.092418293e-10 7.413614275e-10 8.139421457e-10 8.427219751e-10 5.944031905e-10 5.042722302e-10 3.303632276e-10 2.500391588e-10 1.889344621e-10 1.281776665e-07 1.492019953e-10 1.101193024e-10 1.048946625e-10
 2.627847415e-11 4.35761606e-10 6.343878834e-10 6.964956847e-10 7.211227753e-10 5.086347468e-10 4.315090871e-10 2.826940018e-10 2.139601642e-10 1.616724705e-10 1.492019953e-10 1.706724195e-07 9.422981635e-11 8.975905741e-11
 1.939496342e-11 3.216161015e-10 4.682132503e-10 5.140522334e-10 5.322283848e-10 3.75400499e-10 3.18477508e-10 2.086437665e-10 1.57914403e-10 1.19323201e-10 1.101193024e-10 9.422981635e-11 2.66806697e-07 6.624713541e-11
 1.847476418e-11 3.063569392e-10 4.459987469e-10 4.896628872e-10 5.069766662e-10 3.575895215e-10 3.033672571e-10 1.98744607e-10 1.504221118e-10 1.136618797e-10 1.048946625e-10 8.975905741e-11 6.624713541e-11 1.081358582e-07
"""

icov = """
 1.925517986e-07 8.641930131e-11 1.172465457e-10 1.258299804e-10 1.322289373e-10 8.310499466e-11 7.492342052e-11 6.511431925e-11 5.942521721e-11 5.036753513e-11 4.738887799e-11 4.137676206e-11 2.357618816e-11 2.134573105e-11
 8.641930131e-11 1.407436288e-07 1.711749934e-09 1.837064447e-09 1.930486509e-09 1.213297742e-09 1.093850223e-09 9.506414966e-10 8.675830151e-10 7.353446911e-10 6.918575577e-10 6.040832103e-10 3.442023667e-10 3.116386371e-10
 1.172465457e-10 1.711749934e-09 1.031585337e-07 2.492376789e-09 2.6191241e-09 1.64610182e-09 1.484045326e-09 1.289751595e-09 1.177064731e-09 9.976547327e-10 9.386549943e-10 8.195700343e-10 4.669852442e-10 4.228054748e-10
 1.258299804e-10 1.837064447e-09 2.492376789e-09 1.378718758e-07 2.810866044e-09 1.766610338e-09 1.592689943e-09 1.384172275e-09 1.263235783e-09 1.070691462e-09 1.007372446e-09 8.795694639e-10 5.011724974e-10 4.537583967e-10
 1.322289373e-10 1.930486509e-09 2.6191241e-09 2.810866044e-09 9.954532511e-08 1.856449527e-09 1.673684586e-09 1.454562962e-09 1.327476367e-09 1.125140398e-09 1.058601357e-09 9.24299083e-10 5.266591199e-10 4.768338229e-10
 8.310499466e-11 1.213297742e-09 1.64610182e-09 1.766610338e-09 1.856449527e-09 1.213974599e-07 1.051899466e-09 9.141830042e-10 8.34309937e-10 7.071431462e-10 6.65323808e-10 5.809157353e-10 3.310017023e-10 2.996868394e-10
 7.492342052e-11 1.093850223e-09 1.484045326e-09 1.592689943e-09 1.673684586e-09 1.051899466e-09 1.319813423e-07 8.241829259e-10 7.521732539e-10 6.375258615e-10 5.998235805e-10 5.237253681e-10 2.984150331e-10 2.701830761e-10
 6.511431925e-11 9.506414966e-10 1.289751595e-09 1.384172275e-09 1.454562962e-09 9.141830042e-10 8.241829259e-10 1.261848385e-07 6.53697456e-10 5.540598946e-10 5.212936601e-10 4.551583548e-10 2.593460309e-10 2.348102496e-10
 5.942521721e-11 8.675830151e-10 1.177064731e-09 1.263235783e-09 1.327476367e-09 8.34309937e-10 7.521732539e-10 6.53697456e-10 1.056038015e-07 5.056511373e-10 4.757477209e-10 4.153907222e-10 2.366867134e-10 2.142946474e-10
 5.036753513e-11 7.353446911e-10 9.976547327e-10 1.070691462e-09 1.125140398e-09 7.071431462e-10 6.375258615e-10 5.540598946e-10 5.056511373e-10 1.191942316e-07 4.03233529e-10 3.520762359e-10 2.006105642e-10 1.81631531e-10
 4.738887799e-11 6.918575577e-10 9.386549943e-10 1.007372446e-09 1.058601357e-09 6.65323808e-10 5.998235805e-10 5.212936601e-10 4.757477209e-10 4.03233529e-10 1.481719398e-07 3.312549987e-10 1.887467697e-10 1.708901267e-10
 4.137676206e-11 6.040832103e-10 8.195700343e-10 8.795694639e-10 9.24299083e-10 5.809157353e-10 5.237253681e-10 4.551583548e-10 4.153907222e-10 3.520762359e-10 3.312549987e-10 1.965560442e-07 1.648009092e-10 1.492096967e-10
 2.357618816e-11 3.442023667e-10 4.669852442e-10 5.011724974e-10 5.266591199e-10 3.310017023e-10 2.984150331e-10 2.593460309e-10 2.366867134e-10 2.006105642e-10 1.887467697e-10 1.648009092e-10 2.936453269e-07 8.501863628e-11
 2.134573105e-11 3.116386371e-10 4.228054748e-10 4.537583967e-10 4.768338229e-10 2.996868394e-10 2.701830761e-10 2.348102496e-10 2.142946474e-10 1.81631531e-10 1.708901267e-10 1.492096967e-10 8.501863628e-11 1.529401363e-07
"""


# sdssg band shifted to rest frame
print(model.source._colordisp(4717.599777 / 1.221))

# total chisq:
model.set(z=0.221,
          t0=54390.4105525,
          x0=5.52396533233e-05,
          x1=-1.62106970624,
          c=0.079535505334)

times = np.array([54346.219, 54356.262, 54358.207, 54359.172, 54365.238,
                  54373.313, 54382.246, 54386.25,  54388.254, 54393.238,
                  54403.168, 54406.16,  54412.16,  54416.156, 54420.184,
                  54421.164, 54423.156, 54425.156, 54431.164, 54433.1])
model_rcov = model._bandflux_rcov('sdssg', times)
relerr2 = np.diag(model_rcov) - model_rcov[0, 1]
for i, t in enumerate(times):
    print(i, t, relerr2[i])

data = sncosmo.read_lc('jla_light_curves/lc-SDSS19230.list',
                       format='salt2', read_covmat=True)
# print(data)
data = sncosmo.photdata.photometric_data(data)

mask = sncosmo.fitting._data_mask(data, model.get('t0'), model.get('z'),
                                  (-15., 45.), (3000., 7000.))
# print(len(data[mask]))
# print(sncosmo.chisq(data[mask], model, modelcov=True))
# print(data[mask])
result, fitted_model = sncosmo.fit_lc(data, model, ['t0', 'x0', 'x1', 'c'],
                                       guess_amplitude=False, guess_t0=False,
                                       phase_range=(-15., 45.), wave_range=(3000., 7000.), modelcov=True)

print(result)
